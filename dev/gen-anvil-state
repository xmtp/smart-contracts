#!/bin/bash
set -euo pipefail

# anvil first well-known private key
export LOCAL_DEPLOY_PRIVATE_KEY=0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80

wait_for_valid_json() {
  local file="$1"
  local interval="${2:-1}"  # seconds between checks (default: 1)

  echo "⏳ Waiting for valid JSON in: $file"

  until [[ -f "$file" ]] && jq empty "$file" >/dev/null 2>&1; do
    sleep "$interval"
  done

  echo "✅ File is now valid JSON: $file"
}

rm -f ./anvil-state.json || echo "no existing state to remove"

echo "▶ Starting anvil..."
anvil --dump-state anvil-state.json &

ANVIL_PID=$!
trap 'kill $ANVIL_PID 2>/dev/null || true; wait $ANVIL_PID 2>/dev/null || true' EXIT

# Wait for anvil to start
sleep 2

echo "▶ Running deploy-local..."
npm run deploy-local

sleep 10

echo "▶ Waiting for anvil to flush state..."
kill -SIGINT "$ANVIL_PID"  # sends Ctrl+C, triggers graceful shutdown
wait "$ANVIL_PID"

# Wait for the state file to become valid JSON
wait_for_valid_json ./anvil-state.json

echo "🟢 Done generating anvil state."