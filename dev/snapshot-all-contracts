#!/bin/bash

# Script to snapshot all contract states from both settlement and app chains

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Usage information
usage() {
    echo -e "${CYAN}Contract State Snapshot${NC}"
    echo ""
    echo "Captures the current state of all deployed contracts from both settlement-chain"
    echo "and app-chain, combining them into a single timestamped JSON file."
    echo ""
    echo -e "${YELLOW}USAGE:${NC}"
    echo "    ENVIRONMENT=<env> ./dev/snapshot-all-contracts [output_file]"
    echo ""
    echo -e "${YELLOW}EXAMPLES:${NC}"
    echo "    # Create timestamped snapshot in export/ directory"
    echo "    ENVIRONMENT=testnet-dev ./dev/snapshot-all-contracts"
    echo ""
    echo "    # Create snapshot with custom filename"
    echo "    ENVIRONMENT=testnet-dev ./dev/snapshot-all-contracts export/my-snapshot.json"
    echo ""
    echo "    # Snapshot production environment"
    echo "    ENVIRONMENT=mainnet ./dev/snapshot-all-contracts"
    echo ""
    echo -e "${YELLOW}SUPPORTED ENVIRONMENTS:${NC}"
    echo "    - testnet-dev"
    echo "    - testnet"
    echo "    - testnet-staging"
    echo "    - testnet-gateways"
    echo "    - mainnet"
    echo ""
    echo -e "${YELLOW}OUTPUT:${NC}"
    echo "    Creates a JSON file with structure:"
    echo "    {"
    echo '      "environment": "testnet-dev",'
    echo '      "timestamp": "2025-12-02T18:31:14Z",'
    echo '      "settlement-chain": { ... },'
    echo '      "app-chain": { ... }'
    echo "    }"
    echo ""
    echo -e "${YELLOW}VIEWING SNAPSHOTS:${NC}"
    echo "    # View entire snapshot"
    echo "    jq . export/testnet-dev-20251202-183022.json"
    echo ""
    echo "    # View specific contract"
    echo '    jq '"'"'.["settlement-chain"].contracts.nodeRegistry'"'"' export/snapshot.json'
    echo ""
    echo "    # Compare two snapshots"
    echo "    diff <(jq -S . snapshot1.json) <(jq -S . snapshot2.json)"
    echo ""
}

# Check for help flag
if [ "$1" = "-h" ] || [ "$1" = "--help" ]; then
    usage
    exit 0
fi

# Check required environment variables
if [ -z "$ENVIRONMENT" ]; then
    echo -e "${RED}Error: ENVIRONMENT variable not set${NC}"
    echo ""
    usage
    exit 1
fi

# Determine output file
OUTPUT_FILE="${1:-export/${ENVIRONMENT}-$(date +%Y%m%d-%H%M%S).json}"
SNAPSHOT_DIR=$(dirname "$OUTPUT_FILE")

# Create export directory if it doesn't exist
mkdir -p "$SNAPSHOT_DIR"

# Ensure directory is writable
if [ ! -w "$SNAPSHOT_DIR" ]; then
    echo -e "${RED}Error: Directory ${SNAPSHOT_DIR} is not writable${NC}"
    exit 1
fi

echo -e "${GREEN}Snapshotting contracts for environment: ${ENVIRONMENT}${NC}"
echo -e "${GREEN}Output file: ${OUTPUT_FILE}${NC}"
echo ""

# Temporary files for settlement and app chain snapshots
SETTLEMENT_TEMP=$(mktemp)
APP_TEMP=$(mktemp)

# Clean up temp files on exit
trap 'rm -f "$SETTLEMENT_TEMP" "$APP_TEMP"' EXIT

# Determine RPC URLs based on environment
case $ENVIRONMENT in
    testnet-dev|testnet|testnet-staging|testnet-gateways)
        SETTLEMENT_RPC="base_sepolia"
        APP_RPC="xmtp_ropsten"
        ;;
    mainnet)
        SETTLEMENT_RPC="base"
        APP_RPC="xmtp"
        ;;
    *)
        echo -e "${RED}Warning: Unknown environment. Using default RPCs.${NC}"
        SETTLEMENT_RPC="base_sepolia"
        APP_RPC="xmtp_ropsten"
        ;;
esac

# Snapshot settlement chain
echo -e "${YELLOW}Snapshotting settlement chain contracts...${NC}"
if forge script SnapshotContracts \
    --rpc-url "$SETTLEMENT_RPC" \
    --sig "SnapshotSettlementChain()" \
    2>&1 | awk '/^== Logs ==$/{flag=1; next} flag' > "$SETTLEMENT_TEMP"; then
    echo -e "${GREEN}✓ Settlement chain snapshot complete${NC}"
else
    echo -e "${RED}✗ Failed to snapshot settlement chain${NC}"
    exit 1
fi

# Snapshot app chain
echo -e "${YELLOW}Snapshotting app chain contracts...${NC}"
if forge script SnapshotContracts \
    --rpc-url "$APP_RPC" \
    --sig "SnapshotAppChain()" \
    2>&1 | awk '/^== Logs ==$/{flag=1; next} flag' > "$APP_TEMP"; then
    echo -e "${GREEN}✓ App chain snapshot complete${NC}"
else
    echo -e "${RED}✗ Failed to snapshot app chain${NC}"
    exit 1
fi

# Combine into single JSON file
echo -e "${YELLOW}Combining snapshots into single JSON file...${NC}"

cat > "$OUTPUT_FILE" << EOF
{
  "environment": "$ENVIRONMENT",
  "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "settlement-chain": $(cat "$SETTLEMENT_TEMP"),
  "app-chain": $(cat "$APP_TEMP")
}
EOF

echo -e "${GREEN}✓ Combined snapshot saved to: ${OUTPUT_FILE}${NC}"
echo ""

# Show summary
echo -e "${GREEN}Snapshot Summary:${NC}"
echo "  Environment: $ENVIRONMENT"
echo "  Settlement Chain ID: $(jq -r '."settlement-chain".chainId' "$OUTPUT_FILE")"
echo "  App Chain ID: $(jq -r '."app-chain".chainId' "$OUTPUT_FILE")"
echo "  Settlement Contracts: $(jq -r '."settlement-chain".contracts | keys | length' "$OUTPUT_FILE")"
echo "  App Contracts: $(jq -r '."app-chain".contracts | keys | length' "$OUTPUT_FILE")"
echo ""
echo -e "${GREEN}To view the snapshot:${NC}"
echo "  jq . $OUTPUT_FILE"
echo ""
echo -e "${GREEN}To view a specific contract:${NC}"
echo "  jq '.[\"settlement-chain\"].contracts.nodeRegistry' $OUTPUT_FILE"
echo "  jq '.[\"app-chain\"].contracts.appChainGateway' $OUTPUT_FILE"

